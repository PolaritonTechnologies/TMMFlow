{% extends "base.html" %}
{% block content %}
<main class="container-custom">
    <div class="row align-items-center ">
        <div class="col-2 d-flex flex-column justify-content-center">
            <p> Select a material</p>
            <div style="margin-bottom: 2em;">
                <select name="materials" id="materials" class="form-control">
                    {% for material_class, materials in grouped_materials.items() %}
                    <optgroup label="{{ material_class }}">
                        {% for material in materials %}
                        <option value="{{ material }}" data-class="{{ material_class }}">{{ material }}</option>
                        {% endfor %}
                    </optgroup>
                    {% endfor %}
                </select>
            </div>
            <div style="margin-bottom: 2em;">
                <button class="btn btn-primary form-control" id="downloadButton"
                    style="margin-bottom: 1em;">Download</button>
                <button class="btn btn-danger form-control" id="deleteMaterialButton" data-toggle="modal"
                    data-target="#deleteModal">Delete Material</button>
                <!-- Add horizontal line -->
                <hr>
                <p> Upload new material</p>
                <button class="btn btn-primary form-control" id="uploadMaterialButton" data-toggle="modal"
                    data-target="#uploadModal">Upload</button>
            </div>
            <!-- Delete Confirmation Modal -->
            <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            Are you sure you want to delete this material?
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-danger" id="confirmDeleteButton">Accept</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Upload Material Modal -->
            <div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="uploadModalLabel">Upload New Material</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="uploadMaterialForm">
                                <div class="form-group">
                                    <label for="materialName">Material Name</label>
                                    <input type="text" id="materialName" name="materialName" class="form-control"
                                        placeholder="Material Name" required>
                                </div>
                                <div class="form-group">
                                    <label for="materialClasses">Material Class</label>
                                    <select name="materialClasses" id="materialClasses" class="form-control" required>
                                        <option value="" disabled selected>Select a material class</option>
                                        {% for material_class, materials in grouped_materials.items() %}
                                        <option value="{{ material_class }}">{{ material_class }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="fileUpload">Choose file</label>
                                    <div class="custom-file">
                                        <input type="file" class="custom-file-input" id="fileUpload" name="fileUpload"
                                            required>
                                        <label class="custom-file-label" for="fileUpload">Choose file</label>
                                    </div>
                                </div>
                            </form>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="confirmUploadButton">Upload</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- <p> Upload new material</p> -->
            <!-- <input type="file" id="fileUpload" style="display: none;" /> -->
            <!-- <button class="btn btn-primary" id="uploadButton">Upload</button> -->
            <!-- <div class="row d-flex justify-content-center align-items-center"> -->
            <!-- <button class="btn btn-success" id="acceptButton" -->
            <!-- style="display: none; margin-top: 1em; margin-right: 1em;">Accept</button> -->
            <!-- <button class="btn btn-danger" id="rejectButton" -->
            <!-- style="display: none; margin-top: 1em; margin-left: 1em;">Reject</button> -->
            <!-- </div> -->
        </div>
        <div class="col-8" id="plotDiv"></div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
    var selectedMaterial;
    var materialsSelect = document.getElementById('materials');

    materialsSelect.addEventListener('change', function () {
        selectedMaterial = this.value;
        fetch('/get_material_data_ajax', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ material: selectedMaterial }),
        })
            .then(response => response.json())
            .then(data => {
                var traces = data.y.map(function (y, index) {
                    return {
                        x: data.x,
                        y: y,
                        mode: 'lines',
                        name: data.name[index]
                    };
                });

                var layout = {
                    title: {
                        text: selectedMaterial,
                        font: {
                            size: 18
                        }
                    },
                    xaxis: {
                        title: {
                            text: 'Wavelength (nm)',
                            font: {
                                size: 18
                            }
                        }
                    },
                    yaxis: {
                        title: {
                            text: 'n, k',
                            font: {
                                size: 18
                            }
                        }
                    },
                    height: window.innerHeight * 0.7 // Set the height to 80% of the viewport height
                };
                var config = {
                    modeBarButtonsToAdd: [{
                        name: 'Log Scale',
                        title: 'log',
                        click: function (gd) {
                            var update = { 'yaxis.type': 'log' };
                            Plotly.relayout(gd, update);
                        }
                    }, {
                        name: 'Linear Scale',
                        title: 'lin',
                        click: function (gd) {
                            var update = { 'yaxis.type': 'linear' };
                            Plotly.relayout(gd, update);
                        }
                    }]
                };

                Plotly.newPlot('plotDiv', traces, layout, config);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
    });

    // Trigger the 'change' event manually
    var event = new Event('change');
    materialsSelect.dispatchEvent(event);

    document.getElementById("downloadButton").addEventListener("click", function (e) {
        e.preventDefault();
        var fileName = document.getElementById("materials").value;

        fetch('/download_material?fileName=' + fileName)
            .then(response => response.blob())
            .then(blob => {
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a); // we need to append the element to the dom -> otherwise it will not work in firefox
                a.click();
                a.remove();  //afterwards we remove the element again         
            });
    });

    $(document).ready(function () {
        $('#materials').on('change', function () {
            const selectedOption = $(this).find('option:selected');
            const materialClass = selectedOption.data('class');
            const deleteButton = $('#deleteMaterialButton');

            if (materialClass === 'default') {
                deleteButton.prop('disabled', true);
            } else {
                deleteButton.prop('disabled', false);
            }
        });
        $('#deleteMaterialButton').on('click', function () {
            $('#deleteModal').modal('show');
        });

        $('#confirmDeleteButton').on('click', function () {
            // Get the selected material
            const selectedMaterial = $('#materials').val();
            if (selectedMaterial) {
                deleteMaterial(selectedMaterial);
            }
            $('#deleteModal').modal('hide');
        });
    });

    function deleteMaterial(material) {
        // Make an AJAX request to the server to delete the material
        console.log("Here");
        $.ajax({
            url: '/delete_material',  // Adjust the URL to your Flask route
            type: 'POST',
            data: { material: material },
            success: function (response) {
                // Handle success response
                console.log('Material deleted successfully');
                // Optionally, refresh the page or update the UI
                location.reload();
            },
            error: function (error) {
                // Handle error response
                console.error('Error deleting material:', error);
            }
        });
    }

    $(document).ready(function () {
        $('#uploadMaterialButton').on('click', function () {
            $('#uploadModal').modal('show');
        });

        $('#confirmUploadButton').on('click', function () {
            const fileInput = document.getElementById('fileUpload');
            const file = fileInput.files[0];
            if (file) {
                uploadMaterial(file);
            }
            $('#uploadModal').modal('hide');
        });
    });

    function uploadMaterial(file) {
        const formData = new FormData();
        formData.append('file', file);

        $.ajax({
            url: '/upload_material',  // Adjust the URL to your Flask route
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                // Handle success response
                console.log('Material uploaded successfully');
                // Optionally, refresh the page or update the UI
                location.reload();
            },
            error: function (error) {
                // Handle error response
                console.error('Error uploading material:', error);
            }
        });
    }

</script>
{% endblock %}